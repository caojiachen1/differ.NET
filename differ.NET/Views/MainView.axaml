<?xml version="1.0" encoding="utf-8"?>
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:differ.NET.ViewModels"
             xmlns:models="clr-namespace:differ.NET.Models"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="differ.NET.Views.MainView"
             x:DataType="vm:MainViewModel">
  <Design.DataContext>
    <vm:MainViewModel />
  </Design.DataContext>

  <Grid RowDefinitions="Auto,*,Auto">
    <Border Grid.Row="0" Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
            BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
            BorderThickness="0,0,0,1"
            Padding="16,12">
      <Grid ColumnDefinitions="Auto,*,Auto">
        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
          <Button Command="{Binding SelectFolderCommand}"
                  Classes="accent"
                  IsEnabled="{Binding !IsLoading}">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <PathIcon Data="M19,20H4C2.89,20 2,19.1 2,18V6C2,4.89 2.89,4 4,4H10L12,6H19A2,2 0 0,1 21,8H21L4,8V18L6.14,10H23.21L20.93,18.5C20.7,19.37 19.92,20 19,20Z" Width="16" Height="16"/>
              <TextBlock Text="Select Folder" VerticalAlignment="Center"/>
            </StackPanel>
          </Button>
          
          <CheckBox IsChecked="{Binding IncludeSubfolders}" 
                    Content="Include Subfolders"
                    VerticalAlignment="Center"
                    IsEnabled="{Binding !IsLoading}"/>
          
          <Border Background="{DynamicResource DividerStrokeColorDefaultBrush}" 
                  Width="1" Margin="4,4"/>
          
          <TextBlock Text="Path:" VerticalAlignment="Center" Opacity="0.7"/>
          <TextBlock Text="{Binding CurrentFolder}" 
                     VerticalAlignment="Center"
                     MaxWidth="300"
                     TextTrimming="CharacterEllipsis"
                     ToolTip.Tip="{Binding CurrentFolder}"/>
        </StackPanel>

        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="12">
          <TextBlock Text="Similarity:" VerticalAlignment="Center"/>
          <Slider Value="{Binding SimilarityThreshold}"
                  Minimum="50" Maximum="100"
                  Width="150"
                  VerticalAlignment="Center"/>
          <TextBlock Text="{Binding SimilarityThreshold, StringFormat={}{0:F0}%}" 
                     VerticalAlignment="Center"
                     Width="40"/>
          
          <Button Command="{Binding ClearSourceCommand}"
                  IsVisible="{Binding SourceImage, Converter={x:Static ObjectConverters.IsNotNull}}">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <PathIcon Data="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" Width="14" Height="14"/>
              <TextBlock Text="Clear"/>
            </StackPanel>
          </Button>
        </StackPanel>
      </Grid>
    </Border>

    <Grid Grid.Row="1" ColumnDefinitions="*,Auto,*">
      <Grid Grid.Column="0" RowDefinitions="Auto,*">
        <Border Grid.Row="0" Padding="16,12" 
                Background="{DynamicResource LayerFillColorDefaultBrush}">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <PathIcon Data="M22,16V4A2,2 0 0,0 20,2H8A2,2 0 0,0 6,4V16A2,2 0 0,0 8,18H20A2,2 0 0,0 22,16M11,12L13.03,14.71L16,11L20,16H8M2,6V20A2,2 0 0,0 4,22H18V20H4V6" Width="18" Height="18"/>
            <TextBlock Text="Image Library" FontSize="16" FontWeight="SemiBold"/>
            <TextBlock Text="{Binding Images.Count, StringFormat=({0})}" 
                       Opacity="0.6" VerticalAlignment="Center"/>
          </StackPanel>
        </Border>

        <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Disabled">
          <ItemsControl ItemsSource="{Binding Images}" Margin="8" Name="ImageGallery">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <WrapPanel/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="models:ImageItem">
                <Border Margin="4" 
                        CornerRadius="8"
                        Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        ClipToBounds="True"
                        Cursor="Hand"
                        Tag="{Binding}"
                        PointerPressed="OnImagePointerPressed">
                  <Border.ContextFlyout>
                    <MenuFlyout>
                      <MenuItem Header="Set as Search Source" 
                                Click="OnSetAsSourceClick"
                                Tag="{Binding}">
                        <MenuItem.Icon>
                          <PathIcon Data="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" Width="14" Height="14"/>
                        </MenuItem.Icon>
                      </MenuItem>
                      <Separator/>
                      <MenuItem Header="Open File Location"
                                Click="OnOpenFileLocationClick"
                                Tag="{Binding}">
                        <MenuItem.Icon>
                          <PathIcon Data="M19,20H4C2.89,20 2,19.1 2,18V6C2,4.89 2.89,4 4,4H10L12,6H19A2,2 0 0,1 21,8H21L4,8V18L6.14,10H23.21L20.93,18.5C20.7,19.37 19.92,20 19,20Z" Width="14" Height="14"/>
                        </MenuItem.Icon>
                      </MenuItem>
                    </MenuFlyout>
                  </Border.ContextFlyout>
                  
                  <Grid RowDefinitions="150,Auto">
                    <Border Grid.Row="0" Width="150" Height="150"
                            Background="{DynamicResource LayerFillColorDefaultBrush}">
                      <Image Source="{Binding Thumbnail}"
                             Stretch="Uniform"
                             VerticalAlignment="Center"
                             HorizontalAlignment="Center"/>
                    </Border>
                    <Border Grid.Row="1" Padding="8,6"
                            Background="{DynamicResource LayerFillColorAltBrush}">
                      <TextBlock Text="{Binding FileName}"
                                 TextTrimming="CharacterEllipsis"
                                 MaxWidth="134"
                                 FontSize="11"
                                 Opacity="0.8"
                                 ToolTip.Tip="{Binding FileName}"/>
                    </Border>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>

        <Border Grid.Row="1" 
                IsVisible="{Binding IsLoading}"
                Background="#80000000">
          <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="12">
            <ProgressBar IsIndeterminate="True" Width="120"/>
            <TextBlock Text="Loading images..." Foreground="White" FontSize="14"/>
          </StackPanel>
        </Border>
      </Grid>

      <GridSplitter Grid.Column="1" Width="4" 
                    Background="{DynamicResource DividerStrokeColorDefaultBrush}"
                    ResizeDirection="Columns"/>

      <Grid Grid.Column="2" RowDefinitions="Auto,Auto,Auto,*">
        <Border Grid.Row="0" Padding="16,12"
                Background="{DynamicResource LayerFillColorDefaultBrush}">
          <Grid ColumnDefinitions="*,Auto">
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
              <PathIcon Data="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" Width="18" Height="18"/>
              <TextBlock Text="Similar Images" FontSize="16" FontWeight="SemiBold"/>
              <TextBlock Text="{Binding SimilarImages.Count, StringFormat=({0})}" 
                         Opacity="0.6" VerticalAlignment="Center"/>
            </StackPanel>
          </Grid>
        </Border>

        <!-- Compare Folder Settings -->
        <Border Grid.Row="1" Margin="12,12,12,0" Padding="12" CornerRadius="8"
                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                BorderThickness="1">
          <StackPanel Spacing="8">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <PathIcon Data="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z" Width="16" Height="16"/>
              <TextBlock Text="Compare Folder" FontWeight="SemiBold"/>
            </StackPanel>
            
            <StackPanel Orientation="Horizontal" Spacing="8">
              <Button Command="{Binding SelectCompareFolderCommand}" 
                      IsEnabled="{Binding !IsLoading}"
                      Padding="8,4">
                <TextBlock Text="Select Folder" FontSize="12"/>
              </Button>
              <CheckBox IsChecked="{Binding CompareIncludeSubfolders}" 
                        Content="Subfolders"
                        FontSize="12"
                        VerticalAlignment="Center"
                        IsEnabled="{Binding !IsLoading}"/>
              <Button Command="{Binding ClearCompareFolderCommand}" 
                      IsVisible="{Binding UseCompareFolder}"
                      Padding="8,4">
                <TextBlock Text="Clear" FontSize="12"/>
              </Button>
            </StackPanel>
            
            <StackPanel Orientation="Horizontal" Spacing="4" 
                        IsVisible="{Binding UseCompareFolder}">
              <TextBlock Text="Path:" FontSize="11" Opacity="0.6"/>
              <TextBlock Text="{Binding CompareFolder}" 
                         FontSize="11" Opacity="0.8"
                         TextTrimming="CharacterEllipsis"
                         MaxWidth="280"
                         ToolTip.Tip="{Binding CompareFolder}"/>
              <TextBlock Text="{Binding CompareImages.Count, StringFormat=({0} images)}" 
                         FontSize="11" Opacity="0.6"/>
            </StackPanel>
            
            <TextBlock Text="No compare folder selected. Will search in library."
                       FontSize="11" Opacity="0.5"
                       IsVisible="{Binding !UseCompareFolder}"/>
          </StackPanel>
        </Border>

        <Border Grid.Row="2" 
                Margin="12" 
                Padding="12"
                CornerRadius="8"
                Background="{DynamicResource CardBackgroundFillColorSecondaryBrush}"
                BorderBrush="{DynamicResource AccentFillColorDefaultBrush}"
                BorderThickness="2"
                IsVisible="{Binding SourceImage, Converter={x:Static ObjectConverters.IsNotNull}}">
          <Grid ColumnDefinitions="Auto,*">
            <Border Grid.Column="0" Width="100" Height="100" 
                    CornerRadius="6"
                    ClipToBounds="True"
                    Background="{DynamicResource LayerFillColorDefaultBrush}">
              <Image Source="{Binding SourceImage.Thumbnail}" Stretch="Uniform"/>
            </Border>
            <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center" Spacing="4">
              <TextBlock Text="Search Source" FontWeight="SemiBold" FontSize="14"/>
              <TextBlock Text="{Binding SourceImage.FileName}" 
                         TextTrimming="CharacterEllipsis"
                         Opacity="0.7"/>
              <TextBlock Text="{Binding SourceImage.FilePath}" 
                         TextTrimming="CharacterEllipsis"
                         FontSize="11"
                         Opacity="0.5"
                         ToolTip.Tip="{Binding SourceImage.FilePath}"/>
            </StackPanel>
          </Grid>
        </Border>

        <Border Grid.Row="2" 
                Margin="12" 
                Padding="16"
                CornerRadius="8"
                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                IsVisible="{Binding SourceImage, Converter={x:Static ObjectConverters.IsNull}}">
          <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
            <PathIcon Data="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" Width="18" Height="18" Opacity="0.6"/>
            <TextBlock Text="Right-click an image and select 'Set as Search Source'" 
                       Opacity="0.6"
                       VerticalAlignment="Center"/>
          </StackPanel>
        </Border>

        <ScrollViewer Grid.Row="3" HorizontalScrollBarVisibility="Disabled">
          <ItemsControl ItemsSource="{Binding SimilarImages}" Margin="8">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <WrapPanel/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="models:ImageItem">
                <Border Margin="4" 
                        CornerRadius="8"
                        Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        ClipToBounds="True">
                  <Grid RowDefinitions="150,Auto">
                    <Border Grid.Row="0" Width="150" Height="150"
                            Background="{DynamicResource LayerFillColorDefaultBrush}">
                      <Image Source="{Binding Thumbnail}"
                             Stretch="Uniform"
                             VerticalAlignment="Center"
                             HorizontalAlignment="Center"/>
                    </Border>
                    
                    <Border Grid.Row="0" 
                            HorizontalAlignment="Right"
                            VerticalAlignment="Top"
                            Margin="6"
                            Padding="6,3"
                            CornerRadius="4"
                            Background="{DynamicResource AccentFillColorDefaultBrush}">
                      <TextBlock Text="{Binding Similarity, StringFormat={}{0:F1}%}"
                                 Foreground="White"
                                 FontSize="11"
                                 FontWeight="SemiBold"/>
                    </Border>
                    
                    <Border Grid.Row="1" Padding="8,6"
                            Background="{DynamicResource LayerFillColorAltBrush}">
                      <TextBlock Text="{Binding FileName}"
                                 TextTrimming="CharacterEllipsis"
                                 MaxWidth="134"
                                 FontSize="11"
                                 Opacity="0.8"
                                 ToolTip.Tip="{Binding FileName}"/>
                    </Border>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>

        <Border Grid.Row="3" 
                IsVisible="{Binding IsSearching}"
                Background="#80000000">
          <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="12">
            <ProgressBar IsIndeterminate="True" Width="120"/>
            <TextBlock Text="Finding similar images..." Foreground="White" FontSize="14"/>
          </StackPanel>
        </Border>
      </Grid>
    </Grid>

    <Border Grid.Row="2" 
            Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
            BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
            BorderThickness="0,1,0,0"
            Padding="16,8">
      <Grid ColumnDefinitions="*,Auto">
        <TextBlock Grid.Column="0" 
                   Text="{Binding StatusText}" 
                   VerticalAlignment="Center"
                   Opacity="0.8"/>
        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16">
          <TextBlock Text="{Binding ProcessedImages, StringFormat=Processed: {0}}" 
                     Opacity="0.6" VerticalAlignment="Center"
                     IsVisible="{Binding IsLoading}"/>
          <TextBlock Text="{Binding TotalImages, StringFormat=Total: {0}}" 
                     Opacity="0.6" VerticalAlignment="Center"
                     IsVisible="{Binding IsLoading}"/>
        </StackPanel>
      </Grid>
    </Border>
  </Grid>
</UserControl>
